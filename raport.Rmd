---
title: "Raport bazy danych"
author: "Kacper Haczkiewicz, Maria Kwintal, Laura Nowak, Paweł Nowak"
date: "Styczeń 2025"
output:
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(kableExtra)
```

```{r db_connect, echo=FALSE}
library(RMariaDB)

conn <- dbConnect(RMariaDB::MariaDB(),
                  dbname = "team22",
                  user = "team22",
                  password = "te@mzazz",
                  host = "giniewicz.it")
```

# Wstęp

Firma Wom-bat Grylls sp. z o.o. specjalizuje się w organizowaniu wycieczek do miast, które odegrały istotną rolę w historii matematyki. Nasz projekt dotyczy stworzenia kompletnej bazy danych wspierającej organizację takich wyjazdów. Dzięki tej bazie możliwe jest przechowywanie i zarządzanie informacjami o miastach, atrakcjach turystycznych, klientach, pracownikach, a także transakcjach i organizowanych wycieczkach. Projekt ten pozwala na efektywne zarządzanie danymi i umożliwia szybkie tworzenie analiz wspierających decyzje biznesowe.

# Opis danych

Nasza baza danych składa się z następujących tabel:

1. **Miasta** - Zawiera informacje o miastach, w których żyli znani matematycy. Przechowywane dane obejmują nazwę miasta, cenę wyjazdu, długość wycieczki oraz nazwisko matematyka związanego z tym miejscem.

2. **Atrakcje w mieście** - Przechowuje dane o atrakcjach turystycznych dostępnych w poszczególnych miastach.

3. **Wycieczki** - Obejmuje informacje o organizowanych wyjazdach, takie jak data rozpoczęcia, czy wycieczka się odbyła oraz do jakiego miasta była skierowana.

4. **Klienci** - Zawiera dane osobowe klientów, takie jak imię, nazwisko, adres e-mail, status studenta oraz przysługujące im zniżki.

5. **Pracownicy** - Informacje o pracownikach zaangażowanych w organizację wycieczek, w tym ich stanowisko oraz dane kontaktowe.

6. **Transakcje** - Rejestruje informacje o zakupach wycieczek przez klientów, takie jak kwota, data transakcji oraz powiązane wycieczki.

7. **Relacje bliskości** - Łączy klientów z ich bliskimi osobami, co umożliwia rejestrację grupowych rezerwacji.

8. **Wynagrodzenie** - Przechowuje informacje o stawkach wynagrodzenia dziennego przypisanych do poszczególnych stanowisk.

9. **Wycieczki i pracownicy** - Łączy wycieczki z przypisanymi do nich pracownikami, co pozwala na tworzenie grafików i zarządzanie zasobami ludzkimi.

# Znaczenie projektu

Baza danych opracowana w ramach tego projektu pełni kluczową rolę w działalności firmy. Umożliwia:

- Efektywne zarządzanie danymi o wycieczkach, klientach i pracownikach.
- Tworzenie analiz sprzedaży i popularności wycieczek.
- Planowanie logistyki oraz monitorowanie wyników finansowych.


# Wyniki

Jako pierwsze, sprawdźmy na jakie wycieczki jest największe zainteresowanie:

```{r sql1, echo=FALSE}

query1 <- "SELECT 
    m.miasto AS wycieczka,
    COUNT(t.id_klienta) AS liczba_osob_zainteresowanych
FROM 
    Wycieczki w
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
LEFT JOIN 
    Transakcje t ON w.id_wycieczki = t.id_wycieczki
GROUP BY 
    m.miasto
ORDER BY 
    liczba_osob_zainteresowanych DESC;"

df1 <- dbGetQuery(conn, query1)

data1 <- head(df1)

kable(data1, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```
Jak widać, najpopularniejszą wycieczką jest `r df1$wycieczka[1]`. 
Jej liczba zainteresowanych to: `r df1$liczba_osob_zainteresowanych[1]`

Teraz porównamy koszta oraz zyski do najpopularniejszych wycieczek:

```{r sql2, echo=FALSE}

query2 <- "WITH Koszty_Wycieczki AS (
    SELECT 
        w.id_wycieczki,
        SUM(wyn.wynagrodzenie * m.dlugosc_wycieczki) AS koszt
    FROM 
        Wycieczki w
    JOIN 
        Wycieczki_pracownicy wp ON w.id_wycieczki = wp.id_wycieczki
    JOIN 
        Pracownicy p ON wp.id_pracownika = p.id_pracownika
    JOIN 
        Wynagrodzenie wyn ON p.stanowisko = wyn.stanowisko
    JOIN 
        Miasta m ON w.id_miasta = m.id_miasta
    WHERE 
        w.odbyla_sie = 1
    GROUP BY 
        w.id_wycieczki
),
Zyski_Wycieczki AS (
    SELECT 
        t.id_wycieczki,
        SUM(t.kwota) AS zysk
    FROM 
        Transakcje t
    JOIN 
        Wycieczki w ON t.id_wycieczki = w.id_wycieczki
    WHERE 
        w.odbyla_sie = 1
    GROUP BY 
        t.id_wycieczki
)
SELECT 
    m.miasto AS wycieczka,
    COUNT(w.id_wycieczki) AS liczba_wycieczek,
    COALESCE(SUM(kw.koszt), 0) AS koszt,
    COALESCE(SUM(zw.zysk), 0) AS przychód,
    COALESCE(SUM(zw.zysk) - SUM(kw.koszt), 0) AS zysk,
    CASE 
        WHEN COALESCE(SUM(zw.zysk) - SUM(kw.koszt), 0) > 0 THEN 'oplacalna'
        ELSE 'nieoplacalna'
    END AS oplacalnosc
FROM 
    Wycieczki w
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
LEFT JOIN 
    Koszty_Wycieczki kw ON w.id_wycieczki = kw.id_wycieczki
LEFT JOIN 
    Zyski_Wycieczki zw ON w.id_wycieczki = zw.id_wycieczki
WHERE 
    w.odbyla_sie = 1
GROUP BY 
    m.miasto
ORDER BY 
    zysk DESC;"

data2 <- dbGetQuery(conn, query2)

kable(data2, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```
Łatwo widać, że największe zyski przynosi nam wycieczka `r data2$wycieczka[1]`. 
Zysk tej wycieczki wynosi: `r data2$zysk[1]`, a przychód: `r data2$przychód[1]`.
Nieopłacalna wycieczka jest do miasta `r data2$wycieczka[data2$oplacalnosc=="nieoplacalna"]`.




```{r sql4, echo=FALSE}
query4 <- "WITH Klienci_Wycieczki AS (
    SELECT 
        t.id_klienta,
        t.id_wycieczki
    FROM 
        Transakcje t
    JOIN 
        Wycieczki w ON t.id_wycieczki = w.id_wycieczki
    WHERE 
        w.odbyla_sie = 1
),
Powroty AS (
    SELECT 
        kw1.id_wycieczki AS pierwsza_wycieczka,
        COUNT(DISTINCT kw1.id_klienta) AS liczba_klientow,
        COUNT(DISTINCT CASE 
            WHEN kw2.id_wycieczki IS NOT NULL AND kw1.id_wycieczki != kw2.id_wycieczki THEN kw1.id_klienta
        END) AS liczba_powracajacych
    FROM 
        Klienci_Wycieczki kw1
    LEFT JOIN 
        Klienci_Wycieczki kw2 ON kw1.id_klienta = kw2.id_klienta
    GROUP BY 
        kw1.id_wycieczki
)
SELECT 
    m.miasto AS wycieczka,
    p.liczba_klientow,
    p.liczba_powracajacych,
    ROUND((p.liczba_powracajacych * 100.0) / p.liczba_klientow, 2) AS procent_powrotow
FROM 
    Powroty p
JOIN 
    Wycieczki w ON p.pierwsza_wycieczka = w.id_wycieczki
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
ORDER BY 
    procent_powrotow DESC;"

df4 <- dbGetQuery(conn, query4)

data4 <- head(df4)

kable(df4, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```
Jak wynika z tabeli, najchętniej (`r df4$procent_powrotow[1]`%) klientów powraca 
do miasta `r df4$wycieczka[1]`. Najmniej osób (`r tail(df4$procent_powrotow,1)`%)
ponownie wybiera się do `r tail(df4$wycieczka, 1)`.


W poniższej tabeli pokazane jest, na jakie dwie wycieczki najchętniej wybierają
się nasi klienci:
```{r sql7, echo=FALSE}
sql7 <- "SELECT 
    m1.miasto AS wycieczka_1,
    m2.miasto AS wycieczka_2,
    COUNT(DISTINCT t1.id_klienta) AS liczba_klientow
FROM 
    Transakcje t1
JOIN 
    Transakcje t2 ON t1.id_klienta = t2.id_klienta AND t1.id_wycieczki < t2.id_wycieczki
JOIN 
    Wycieczki w1 ON t1.id_wycieczki = w1.id_wycieczki
JOIN 
    Wycieczki w2 ON t2.id_wycieczki = w2.id_wycieczki
JOIN 
    Miasta m1 ON w1.id_miasta = m1.id_miasta
JOIN 
    Miasta m2 ON w2.id_miasta = m2.id_miasta
GROUP BY 
    m1.miasto, m2.miasto
ORDER BY 
    liczba_klientow DESC
LIMIT 10;"

df7 <- dbGetQuery(conn, sql7)

kable(df7, caption = "Najpopularniejsze kombinacje dwóch wycieczek odwiedzanych przez tych samych klientów", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```
Wynika z tego, że najwięcej osób z chęcią wybiera się do `r df7$wycieczka_1[1]`
oraz `r df7$wycieczka_2[1]`.


```{r sql8, echo=FALSE}
sql8 <- "SELECT 
    ROUND(AVG(liczba_bliskich), 2) AS srednia_liczba_bliskich
FROM (
    SELECT 
        id_klienta,
        COUNT(id_osoby_bliskiej) AS liczba_bliskich
    FROM 
        Relacje_bliskości
    GROUP BY 
        id_klienta
) AS liczba_bliskich_na_klienta;"

df8 <- dbGetQuery(conn, sql8)
```

Średnia liczba osób bliskich wynosi: `r df8$srednia_liczba_bliskich`.

## Wykresy

Poniższy wykres przedstawia liczbę klientów w danym miesiącu

```{r sql3, echo=FALSE}
query3 <- "SELECT 
    EXTRACT(YEAR FROM T.data_transakcji) AS Rok,
    EXTRACT(MONTH FROM T.data_transakcji) AS Miesiac,
    COUNT(DISTINCT T.id_klienta) AS Liczba_Klientow
FROM 
    Transakcje T
GROUP BY 
    EXTRACT(YEAR FROM T.data_transakcji), EXTRACT(MONTH FROM T.data_transakcji)
ORDER BY 
    Rok, Miesiac;"

df3 <- dbGetQuery(conn, query3)

df3m <- df3 %>%
  mutate(Data = as.Date(paste(Rok, Miesiac, "01", sep = "-")),
         Liczba_Klientow = as.numeric(Liczba_Klientow))

ggplot(df3m, aes(x = Data, y = Liczba_Klientow)) +
  geom_line(color = "magenta", linewidth = 1) +
  geom_point(color = "purple", size = 2) +
  labs(
    title = "Liczba obsłużonych klientów w każdym miesiącu",
    x = "Miesiąc",
    y = "Liczba klientów"
  ) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```



```{r wykres, echo=FALSE}
sql6 <- "SELECT 
    m.miasto AS miasto,
    SUM(t.kwota) AS przychody_miasta,
    ROUND((SUM(t.kwota) * 100.0) / (SELECT SUM(kwota) FROM Transakcje), 2) AS udzial_procentowy
FROM 
    Transakcje t
JOIN 
    Wycieczki w ON t.id_wycieczki = w.id_wycieczki
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
GROUP BY 
    m.miasto
ORDER BY 
    przychody_miasta DESC;"

df6 <- dbGetQuery(conn, sql6)

ggplot(df6, aes(x = miasto, y = udzial_procentowy, fill = miasto)) +
  geom_bar(stat = "identity", width = 1, color = "white", alpha = 0.6) +
  theme(legend.title = element_blank()) +
  theme(axis.text.x = element_blank()) +
  labs(y="Procent" ,title = "Udział procentowy miast w przychodach")
```


Poniższy wykres słupkowy przedstawia, jaka jest średnia klientów na dany wyjazd:
```{r sql5, echo=FALSE}
sql5 <- "SELECT 
    m.miasto AS wycieczka,
    ROUND(AVG(liczba_klientow), 2) AS średnia_liczba_klientów
FROM (
    SELECT 
        w.id_wycieczki,
        w.id_miasta,
        COUNT(t.id_klienta) AS liczba_klientow
    FROM 
        Wycieczki w
    LEFT JOIN 
        Transakcje t ON w.id_wycieczki = t.id_wycieczki
    GROUP BY 
        w.id_wycieczki, w.id_miasta
) WycieczkiOblozenie
JOIN 
    Miasta m ON WycieczkiOblozenie.id_miasta = m.id_miasta
GROUP BY 
    m.miasto
ORDER BY 
    średnia_liczba_klientów DESC;"

df5 <- dbGetQuery(conn, sql5)

ggplot(df5, aes(x=wycieczka, y=średnia_liczba_klientów, fill=wycieczka))+
  geom_bar(stat = "identity") +
  ggtitle("Średnia liczba osób na wycieczki w danym mieście")+
  labs(x = "Miasto", y = "Średnia liczba osób")+
  theme_minimal()+
  theme(axis.text.x = element_blank())
```




# Wnioski

```{r db-close, echo=FALSE}
dbDisconnect(conn)
```

