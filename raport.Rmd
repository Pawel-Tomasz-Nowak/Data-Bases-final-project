---
title: "Raport bazy danych"
author: "Kacper Haczkiewicz, Maria Kwintal, Laura Nowak, Paweł Nowak"
date: "Styczeń 2025"
output:
  pdf_document:
    toc: true
    number_section: true
  html_document:
    toc: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(ggplot2)
library(kableExtra)
```

```{r db_connect, echo=FALSE}
library(RMariaDB)

conn <- dbConnect(RMariaDB::MariaDB(),
                  dbname = "team22",
                  user = "team22",
                  password = "te@mzazz",
                  host = "giniewicz.it")
```

# Wstęp

Firma Wom-bat Grylls sp. z o.o. specjalizuje się w organizowaniu wycieczek do miast, które odegrały istotną rolę w historii matematyki. Nasz projekt dotyczy stworzenia kompletnej bazy danych wspierającej organizację takich wyjazdów. Dzięki tej bazie możliwe jest przechowywanie i zarządzanie informacjami o miastach, atrakcjach turystycznych, klientach, pracownikach, a także transakcjach i organizowanych wycieczkach. Projekt ten pozwala na efektywne zarządzanie danymi i umożliwia szybkie tworzenie analiz wspierających decyzje biznesowe.

# Opis danych

Nasza baza danych składa się z następujących tabel:

1. **Miasta** - Zawiera informacje o miastach, w których żyli znani matematycy. Przechowywane dane obejmują nazwę miasta, cenę wyjazdu, długość wycieczki oraz nazwisko matematyka związanego z tym miejscem.

2. **Atrakcje w mieście** - Przechowuje dane o atrakcjach turystycznych dostępnych w poszczególnych miastach.

3. **Wycieczki** - Obejmuje informacje o organizowanych wyjazdach, takie jak data rozpoczęcia, czy wycieczka się odbyła oraz do jakiego miasta była skierowana.

4. **Klienci** - Zawiera dane osobowe klientów, takie jak imię, nazwisko, adres e-mail, status studenta oraz przysługujące im zniżki.

5. **Pracownicy** - Informacje o pracownikach zaangażowanych w organizację wycieczek, w tym ich stanowisko oraz dane kontaktowe.

6. **Transakcje** - Rejestruje informacje o zakupach wycieczek przez klientów, takie jak kwota, data transakcji oraz powiązane wycieczki.

7. **Relacje bliskości** - Łączy klientów z ich bliskimi osobami, co umożliwia rejestrację grupowych rezerwacji.

8. **Wynagrodzenie** - Przechowuje informacje o stawkach wynagrodzenia dziennego przypisanych do poszczególnych stanowisk.

9. **Wycieczki i pracownicy** - Łączy wycieczki z przypisanymi do nich pracownikami, co pozwala na tworzenie grafików i zarządzanie zasobami ludzkimi.

# Znaczenie projektu

Baza danych opracowana w ramach tego projektu pełni kluczową rolę w działalności firmy. Umożliwia:

- Efektywne zarządzanie danymi o wycieczkach, klientach i pracownikach.
- Tworzenie analiz sprzedaży i popularności wycieczek.
- Planowanie logistyki oraz monitorowanie wyników finansowych.


# Wyniki

Jako pierwsze, sprawdźmy na jakie wycieczki jest największe zainteresowanie:

```{r sql1, echo=FALSE}

query1 <- "SELECT 
    m.miasto AS wycieczka,
    COUNT(t.id_klienta) AS liczba_osob_zainteresowanych
FROM 
    Wycieczki w
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
LEFT JOIN 
    Transakcje t ON w.id_wycieczki = t.id_wycieczki
GROUP BY 
    m.miasto
ORDER BY 
    liczba_osob_zainteresowanych DESC;"

df1 <- dbGetQuery(conn, query1)

data1 <- head(df1)

kable(data1, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```
Jak widać, najpopularniejszą wycieczką jest `r df1$wycieczka[1]`. 
Jej liczba zainteresowanych to: `r df1$liczba_osob_zainteresowanych[1]`

Teraz porównamy koszta oraz zyski do najpopularniejszych wycieczek:

```{r sql2, echo=FALSE}

query2 <- "WITH Koszty_Wycieczki AS (
    SELECT 
        w.id_wycieczki,
        SUM(wyn.wynagrodzenie * m.dlugosc_wycieczki) AS koszt
    FROM 
        Wycieczki w
    JOIN 
        Wycieczki_pracownicy wp ON w.id_wycieczki = wp.id_wycieczki
    JOIN 
        Pracownicy p ON wp.id_pracownika = p.id_pracownika
    JOIN 
        Wynagrodzenie wyn ON p.stanowisko = wyn.stanowisko
    JOIN 
        Miasta m ON w.id_miasta = m.id_miasta
    WHERE 
        w.odbyla_sie = 1
    GROUP BY 
        w.id_wycieczki
),
Zyski_Wycieczki AS (
    SELECT 
        t.id_wycieczki,
        SUM(t.kwota) AS zysk
    FROM 
        Transakcje t
    JOIN 
        Wycieczki w ON t.id_wycieczki = w.id_wycieczki
    WHERE 
        w.odbyla_sie = 1
    GROUP BY 
        t.id_wycieczki
)
SELECT 
    m.miasto AS wycieczka,
    COUNT(w.id_wycieczki) AS liczba_wycieczek,
    COALESCE(SUM(kw.koszt), 0) AS koszt,
    COALESCE(SUM(zw.zysk), 0) AS przychód,
    COALESCE(SUM(zw.zysk) - SUM(kw.koszt), 0) AS zysk,
    CASE 
        WHEN COALESCE(SUM(zw.zysk) - SUM(kw.koszt), 0) > 0 THEN 'oplacalna'
        ELSE 'nieoplacalna'
    END AS oplacalność
FROM 
    Wycieczki w
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
LEFT JOIN 
    Koszty_Wycieczki kw ON w.id_wycieczki = kw.id_wycieczki
LEFT JOIN 
    Zyski_Wycieczki zw ON w.id_wycieczki = zw.id_wycieczki
WHERE 
    w.odbyla_sie = 1
GROUP BY 
    m.miasto
ORDER BY 
    zysk DESC;"

df2 <- dbGetQuery(conn, query2)

data2 <- head(df2)

kable(data2, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```





```{r sql4, echo=FALSE}
query4 <- "WITH Klienci_Wycieczki AS (
    SELECT 
        t.id_klienta,
        t.id_wycieczki
    FROM 
        Transakcje t
    JOIN 
        Wycieczki w ON t.id_wycieczki = w.id_wycieczki
    WHERE 
        w.odbyla_sie = 1
),
Powroty AS (
    SELECT 
        kw1.id_wycieczki AS pierwsza_wycieczka,
        COUNT(DISTINCT kw1.id_klienta) AS liczba_klientow,
        COUNT(DISTINCT CASE 
            WHEN kw2.id_wycieczki IS NOT NULL AND kw1.id_wycieczki != kw2.id_wycieczki THEN kw1.id_klienta
        END) AS liczba_powracajacych
    FROM 
        Klienci_Wycieczki kw1
    LEFT JOIN 
        Klienci_Wycieczki kw2 ON kw1.id_klienta = kw2.id_klienta
    GROUP BY 
        kw1.id_wycieczki
)
SELECT 
    m.miasto AS wycieczka,
    p.liczba_klientow,
    p.liczba_powracajacych,
    ROUND((p.liczba_powracajacych * 100.0) / p.liczba_klientow, 2) AS procent_powrotow
FROM 
    Powroty p
JOIN 
    Wycieczki w ON p.pierwsza_wycieczka = w.id_wycieczki
JOIN 
    Miasta m ON w.id_miasta = m.id_miasta
ORDER BY 
    procent_powrotow DESC;"

df4 <- dbGetQuery(conn, query4)

data4 <- head(df4)

kable(data4, caption = "Liczba osób zainteresowanych na poszczególne wycieczki", align = "l") %>%
  kable_styling(bootstrap_options = c("striped", "bordered", "hover"))
```

## Wykresy

Poniższy wykres przedstawia liczbę klientów w danym miesiącu

```{r sql3, echo=FALSE}
query3 <- "SELECT 
    EXTRACT(YEAR FROM T.data_transakcji) AS Rok,
    EXTRACT(MONTH FROM T.data_transakcji) AS Miesiac,
    COUNT(DISTINCT T.id_klienta) AS Liczba_Klientow
FROM 
    Transakcje T
GROUP BY 
    EXTRACT(YEAR FROM T.data_transakcji), EXTRACT(MONTH FROM T.data_transakcji)
ORDER BY 
    Rok, Miesiac;"

df3 <- dbGetQuery(conn, query3)

df3m <- df3 %>%
  mutate(Data = as.Date(paste(Rok, Miesiac, "01", sep = "-")),
         Liczba_Klientow = as.numeric(Liczba_Klientow))

ggplot(df3m, aes(x = Data, y = Liczba_Klientow)) +
  geom_line(color = "blue", linewidth = 1) +
  geom_point(color = "darkblue", size = 2) +
  labs(
    title = "Liczba obsłużonych klientów w każdym miesiącu",
    x = "Miesiąc",
    y = "Liczba klientów"
  ) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "1 month") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Wnioski

```{r db-close, echo=FALSE}
dbDisconnect(conn)
```

